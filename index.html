<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>hello</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
</head>
<body>
<nav id="TOC" role="doc-toc">
<ul>
<li><a href="#k8sworkshop">K8sWorkshop</a></li>
<li><a href="#me">Me</a></li>
<li><a href="#you">You</a></li>
<li><a href="#accessing-the-cluster">Accessing the Cluster</a></li>
<li><a href="#gitrepository">Gitrepository</a></li>
<li><a href="#authentication-and-authorization-rbac">Authentication and
Authorization (RBAC)</a>
<ul>
<li><a href="#agenda">Agenda</a></li>
</ul></li>
<li><a href="#authentication">Authentication</a></li>
<li><a href="#authentication-methods">Authentication Methods</a></li>
<li><a href="#x509-certificats">x509 Certificats</a></li>
<li><a href="#oidcoauth2">OIDC/Oauth2</a></li>
<li><a href="#authorization">Authorization</a></li>
<li><a href="#rbac">RBAC</a></li>
<li><a href="#plan">Plan</a></li>
<li><a href="#using-curl-to-traverse-the-api">using curl to traverse the
API</a></li>
<li><a href="#interim-conclusion">interim conclusion</a></li>
<li><a href="#have-a-look-into-clusterroles">Have a look into
(Cluster)Roles</a></li>
<li><a href="#check-clusterrolebinding">Check
(Cluster)RoleBinding</a></li>
<li><a href="#do-some-simple-stuff">Do some simple stuff</a></li>
<li><a href="#krew-..-rbac-view">Krew ./. rbac-view</a></li>
<li><a href="#krew-..-rbac-lookup">Krew ./. rbac-lookup</a></li>
<li><a href="#network">Network</a></li>
<li><a href="#overview">Overview</a></li>
<li><a
href="#topologyawarness-of-services-aks-servicediscovery">Topologyawarness
of Services aks ServiceDiscovery</a></li>
<li><a href="#thats-all">That‚Äôs all</a></li>
<li><a href="#networkpolicies">Networkpolicies</a></li>
<li><a href="#what-do-the-networkpolicies-look-like">What do the
NetworkPolicies look like?</a></li>
<li><a href="#an-exampleexercise">An example/exercise</a></li>
<li><a href="#benefits">Benefits</a></li>
<li><a href="#some-examples">Some Examples</a></li>
<li><a href="#lets-diskuss">Let‚Äôs Diskuss</a></li>
<li><a href="#tools-to-debug-network">Tools to debug Network</a></li>
<li><a href="#ephemeral-container">‚Äúephemeral Container‚Äù</a></li>
<li><a href="#np-viewer"><span>np-viewer</span></a></li>
<li><a href="#inspector-gadget"><span>Inspector-Gadget</span></a></li>
<li><a href="#network-visualisation">Network visualisation</a></li>
<li><a href="#skipping">Skipping</a></li>
</ul>
</nav>
<h1 id="k8sworkshop">K8sWorkshop</h1>
<ul>
<li>Not a basic workshop</li>
<li>Just to put attention on some topics</li>
</ul>
<h1 id="me">Me</h1>
<ul>
<li>Erkan Yanar</li>
<li>Dev<em>OPS</em></li>
<li>Find me on LinkedIn(Xing)</li>
<li>linsernraum.de (There will be my homepage by 2024)</li>
</ul>
<h1 id="you">You</h1>
<h1 id="accessing-the-cluster">Accessing the Cluster</h1>
<ul>
<li>To attend the workshop you are getting Credentials to access
jumphost.zwerk.org using SSH.</li>
<li>Feel free to use VSCode with the remote-ssh Plugin to access
jumphost.zwerk.org while still running and working with your graphical
Editor</li>
<li>If not you are going to use Vim oder Mcedit on the jumphost.</li>
<li>I strongly recommend using tmux</li>
</ul>
<h1 id="gitrepository">Gitrepository</h1>
<p>All the examples are in a gitrepository so:</p>
<pre><code>git clone https://github.com/erkules/k8sworkshop.git
cd k8sworkshop</code></pre>
<p>From now on alle commands are expected to be executed from the
<code>k8sworkshop</code> directory</p>
<h1 id="authentication-and-authorization-rbac">Authentication and
Authorization (RBAC)</h1>
<h2 id="agenda">Agenda</h2>
<ul>
<li>Overview Authentiation</li>
<li><ul>
<li>Certs</li>
</ul></li>
<li><ul>
<li>Oauth2/JWT</li>
</ul></li>
<li>Nittygritty of Authorization aka RoleBasedAccessControl (RBAC)</li>
</ul>
<!-- Wir sehen RBAC bei Webhooks und Controllern wieder) -->
<h1 id="authentication">Authentication</h1>
<ul>
<li>There will be nearly no excercises</li>
<li>It is about to find out who you/we are</li>
<li><ul>
<li>User</li>
</ul></li>
<li><ul>
<li>Group</li>
</ul></li>
<li><ul>
<li>ServiceAccount</li>
</ul></li>
</ul>
<h1 id="authentication-methods">Authentication Methods</h1>
<p>There are some ways to authenticate against Kubernetes</p>
<p>As a user you are most likely facing</p>
<ul>
<li>x509 Certificats</li>
<li>OpenID Connect Tokens (or any JWT)</li>
</ul>
<h1 id="x509-certificats">x509 Certificats</h1>
<ul>
<li>You access the k8s cluster using <code>~/.kube/config</code></li>
<li>There is a cert</li>
</ul>
<p>Gonna get it</p>
<pre><code>yq -r  &#39;.users[0].user.&quot;client-certificate-data&quot;&#39;   ~/.kube/config | base64 -d &gt;/tmp/auth.crt
openssl x509  -text -noout -in /tmp/auth.crt</code></pre>
<p>Check for the Subject</p>
<ul>
<li>O ==&gt; Group</li>
<li>CN ==&gt; User</li>
</ul>
<p>Let‚Äôs draw a picture why that cert-stuff works</p>
<h1 id="oidcoauth2">OIDC/Oauth2</h1>
<ul>
<li>Most likely you are going to authenticate against an
oauth-Provider</li>
<li>The provider maybe is just a proxy to you AD (but ü§∑)</li>
</ul>
<h1 id="authorization">Authorization</h1>
<ul>
<li>So after being authenticated</li>
<li>What are wie allowed to do?</li>
</ul>
<h1 id="rbac">RBAC</h1>
<ul>
<li>Role Based Access Control</li>
<li>Let‚Äôs make it more complitaded</li>
</ul>
<h1 id="plan">Plan</h1>
<ul>
<li>using curl to traverse the API</li>
<li>Have a look into (Cluster)Roles</li>
<li>Check (Cluster)RoleBinding</li>
<li>Do some simple stuff</li>
</ul>
<h1 id="using-curl-to-traverse-the-api">using curl to traverse the
API</h1>
<p>Pic about etcd</p>
<pre><code>kubectl proxy</code></pre>
<p>Then do ./RBAC/1x1/README.md</p>
<h1 id="interim-conclusion">interim conclusion</h1>
<p>So it is about to access</p>
<ul>
<li>cluster-scoped objects</li>
<li>namespaced objects</li>
<li>non-resource endpoints exists, but we don‚Äôt care</li>
</ul>
<p>Where access means:</p>
<p>Check for the verbs:</p>
<pre><code>curl localhost:8001/api/v1</code></pre>
<p>verbs:</p>
<table>
<tbody>
<tr class="odd">
<td>get</td>
<td>list</td>
<td>listcollection</td>
</tr>
<tr class="even">
<td>patch</td>
<td>update</td>
<td>watch</td>
</tr>
<tr class="odd">
<td>delete</td>
<td>deletecollection</td>
<td>create</td>
</tr>
</tbody>
</table>
<p>‚Ä¶</p>
<h1 id="have-a-look-into-clusterroles">Have a look into
(Cluster)Roles</h1>
<ul>
<li>admin</li>
<li>cluster-admin</li>
<li>view</li>
<li>system:coredns</li>
</ul>
<h1 id="check-clusterrolebinding">Check (Cluster)RoleBinding</h1>
<p>Basic idea bind (Cluster)Roles to identities/subjects</p>
<table>
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="header">
<th>subjects</th>
<th>How to impersonate</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>User</td>
<td>kubectl get pods ‚Äìas ‚Äìas-group team1</td>
</tr>
<tr class="even">
<td>Group</td>
<td>kubectl get pods ‚Äìas username</td>
</tr>
<tr class="odd">
<td>Serviceaccount</td>
<td>kubectl get pods ‚Äìas system:servcieaccount:testing:test</td>
</tr>
</tbody>
</table>
<h1 id="do-some-simple-stuff">Do some simple stuff</h1>
<pre><code>kubectl apply -f RBAC/hallo-ns-sa-rb.yaml</code></pre>
<p>Question:</p>
<p>But that was the ClusterRole. Is the User hallo now a super-user?</p>
<h1 id="krew-..-rbac-view">Krew ./. rbac-view</h1>
<ul>
<li>Nice WebUI to see (Cluster)Roles</li>
<li>Not ‚Äúworking‚Äù on the jumphost</li>
<li>Because it binds to localhost</li>
</ul>
<pre><code>kubectl krew install  rbac-view
kubectl rbac-view</code></pre>
<h1 id="krew-..-rbac-lookup">Krew ./. rbac-lookup</h1>
<p>Easy way to find (Cluster)Roles (and the bindings)</p>
<pre><code>kubectl krew install  rbac-lookup
kubectl rbac-lookup --kind serviceaccount kamaji-controller-manager -o wide
kubectl rbac-lookup --kind user  bob -o wide</code></pre>
<h1 id="network">Network</h1>
<ul>
<li>Overview</li>
<li>BuildIn noderouting (but s/topologyKeys/internalTrafficPolicy/)</li>
<li>NetworkPolicies</li>
</ul>
<h1 id="overview">Overview</h1>
<ul>
<li>One Network for all Pods</li>
<li>Nothing special about Namespaces (Namespaces are just directories to
organize objects (emember))</li>
</ul>
<h1
id="topologyawarness-of-services-aks-servicediscovery">Topologyawarness
of Services aks ServiceDiscovery</h1>
<ul>
<li>topologyKeys are deprecated :/</li>
<li>There is a (non) replacement</li>
<li>Let‚Äôs meet internalTrafficPolicy</li>
</ul>
<p>Window 1:</p>
<pre><code>watch kubectl get svc,pods -o wide</code></pre>
<p>Window 2:</p>
<pre><code>kubectl apply -f Deployments/deployment-local-svc.yaml
kubectl exec -ti jumper -- sh
&gt; apk add curl
&gt; watch curl -s  http://wahnsinn</code></pre>
<p>Repeat the curl-command and make sure you allways connect to a
node-local Pod</p>
<h1 id="thats-all">That‚Äôs all</h1>
<ul>
<li>There is <a
href="https://kubernetes.io/docs/concepts/services-networking/topology-aware-routing/">Topology
Aware Routing</a></li>
<li>There was topologyKeys for Services but they are deprecated</li>
</ul>
<h1 id="networkpolicies">Networkpolicies</h1>
<p>What you need to understand:</p>
<ul>
<li>A namespaced object (why is that important)</li>
<li>Working with labels (like Service Discovery)</li>
</ul>
<p>Draw it or it didn‚Äôt happen</p>
<p>Questions:</p>
<ul>
<li>What does it means only to have namespaced Networkpolicies?</li>
</ul>
<h1 id="what-do-the-networkpolicies-look-like">What do the
NetworkPolicies look like?</h1>
<pre><code>apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: tored
  namespace: netz
spec:
  podSelector:
    matchLabels:
      farbe: rot
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          farbe: blau
    ports: 
    - port: 80</code></pre>
<h1 id="an-exampleexercise">An example/exercise</h1>
<p>Deploy a Namespace (named netz) with three Deployments (with unique
Labels) and their fitting services</p>
<pre><code>kubectl apply -f Networkpolicies/basics.yaml
kubectl -n netz get deploy,svc,pod -o wide --show-labels </code></pre>
<p>Please:</p>
<ul>
<li><code>Exec</code> into every Pod pod install curl
<code>apk add curl</code> and connect to every service</li>
<li>Apply a NetworkPolicy</li>
</ul>
<pre><code>kubectl -n netz apply -f NetworkPolicies/pod2pod.yaml</code></pre>
<ul>
<li>Now only the Pods from the blau Deployment should be able to access
the Pod from the rot Deployment</li>
<li>It doesn‚Äôt matter if we use the svc or the IP of any Pod (labeled
farbe=rot)</li>
</ul>
<h1 id="benefits">Benefits</h1>
<ul>
<li>Think about shipping your Application with the right
NetworkPolicies</li>
<li>Think about defining default Networkpolicies for your Namespaces
(let‚Äôs show them)</li>
</ul>
<h1 id="some-examples">Some Examples</h1>
<p>Recap:</p>
<pre><code>kind: NetworkPolicy
spec:
  podSelector:     &lt;&lt;-- Find the Pods in the Namepace
    hallo: welt    &lt;&lt;-- using this Label
  ... 
  policyTypes:      #     Could be both or only one:
  - Ingress        &lt;&lt;--   Define Incomming Traffic
  - Egress         &lt;&lt;--   Define Outgoing Traffic
  egress: []       &lt;&lt;--[] Configuration-Array
  ingress:         &lt;&lt;--[] Configuration-Array
  - from:
    - podSelector:
        matchLabels:
          app: www</code></pre>
<h1 id="lets-diskuss">Let‚Äôs Diskuss</h1>
<ul>
<li>Wildcards</li>
<li>Empty Arrays</li>
<li>Egress</li>
</ul>
<h1 id="tools-to-debug-network">Tools to debug Network</h1>
<p>Some nice Tools to ‚Äúdebug‚Äù Network using <code>kubectl</code></p>
<h1 id="ephemeral-container">‚Äúephemeral Container‚Äù</h1>
<p>What are ephemeral containers?</p>
<pre><code>kubectl debug -ti --image=tollesimage &lt;PODName&gt;</code></pre>
<p>And yes not only good for network debugging</p>
<ul>
<li><a
href="https://github.com/ahmetb/kubernetes-network-policy-recipes/blob/master/01-deny-all-traffic-to-an-application.md">Link
mit sch√∂nen animierten Beispielen</a></li>
<li><a href="https://editor.cilium.io">quasiEditor</a></li>
<li><a href="https://orca.tufin.io/netpol/">Auch quasiEditor</a></li>
<li><a href="https://www.inspektor-gadget.io/">Inspector-Gadget</a></li>
<li><a href="https://k8spacket.github.io">k8spacket</a></li>
</ul>
<h1 id="np-viewer"><a
href="https://github.com/runoncloud/kubectl-np-viewer">np-viewer</a></h1>
<pre><code>kubectl krew install np-viewer</code></pre>
<ul>
<li>Simple overview</li>
</ul>
<pre><code>$ kubectl np-viewer -n netz -p rot-5bb7cb48cb-5sj5t

+----------------+---------+-----------+-----------+---------------------+---------------+----------+--------+
| NETWORK POLICY |  TYPE   | NAMESPACE |   PODS    | NAMESPACES SELECTOR | PODS SELECTOR | IP BLOCK | PORTS  |
+----------------+---------+-----------+-----------+---------------------+---------------+----------+--------+
|     tored      | Ingress |   netz    | farbe=rot |        netz         |  farbe=blau   |    *     | TCP:80 |
+----------------+---------+-----------+-----------+---------------------+---------------+----------+--------+</code></pre>
<p>Nice start but only evaluates podSelector <code>:/</code></p>
<pre><code>$ kubectl np-viewer -n netz -p blau-54d9867779-82f4k

No network policy was found</code></pre>
<h1 id="inspector-gadget"><a
href="https://www.inspektor-gadget.io/">Inspector-Gadget</a></h1>
<p>You should have the <a href="https://krew.sigs.k8s.io/">krew plugin
manager</a> installed</p>
<pre><code>kubectl krew install gadget
kubectl gadget deploy</code></pre>
<p>Trace syscalls:</p>
<pre><code>kubectl gadget trace exec -n namespace -p podname </code></pre>
<p>Trace tcp-connections:</p>
<pre><code>kubectl gadget trace tcp -n nameaspace -p podname -c containername</code></pre>
<h1 id="network-visualisation">Network visualisation</h1>
<p>I.e. <a
href="https://github.com/k8spacket/k8spacket">k8spacket</a></p>
<h1 id="skipping">Skipping</h1>
<p>I.e. Calico and Cilium offer additional</p>
<p>Network and Networkpolicies</p>
<pre><code>We recap how the Kubernetes network and routing is working. Beside learning how to manage external routing we learn also about the topology awareness of Services.
This topic is going to be finished with some NetworkPolicy-exercises, where we learn how to create TCP/UDP profiles.</code></pre>
<p>Authentication and Authorization (RBAC)</p>
<pre><code>After a short intro into authentication we dive (kinda deep) into RoleBasedAccessControll (RBAC); a topic not so popular but nevertheless important. RBACs are explained also using etcd. We are going to use a bundle of CLI-tools to make the messy work with RBAC a lot easier.</code></pre>
<p>Webhooks and Controller</p>
<pre><code>What are Webhooks and Controllers? To get into this topic we are going to create simple Webhooks and Controllers. After understanding the concept, we are going to check some real-live Webhooks/Controllers (Most likely Kyverno and a database controller).</code></pre>
</body>
</html>
